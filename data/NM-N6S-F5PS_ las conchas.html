
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<meta name="apple-mobile-web-app-capable" content="yes">

<script type="text/javascript" src="../js/worldFile2.js"></script>
<script type="text/javascript" src="../js/jquery-1.6.4.js"></script>
<script type="text/javascript" src="../js/getImageData.js"></script>
<script type="text/javascript" src="../js/OpenLayers-2.12/OpenLayers.js"></script>
<script type="text/javascript" src="../js/worldFileFire.js"></script>
<script type="text/javascript" src="../js/jquery-1.7.2.min.js"></script>
<script type="text/javascript" src="../js/jquery-ui-1.8.20.custom.min.js"></script>
<link href="../css/excite-bike/jquery-ui-1.8.21.custom.css" rel="stylesheet" type="text/css"/>
<script src="http://maps.google.com/maps/api/js?v=3.5&amp;sensor=false"></script>
<script src="http://api.maps.yahoo.com/ajaxymap?v=3.0&amp;appid=INSERT_YOUR_YAHOO_APP_ID_HERE"></script>
<script src="../js/jquery.ui.touch-punch.min.js"></script>
<script type="text/javascript" src="../js/cloudmade.js"></script>



<style>
    .olLayerGooglePoweredBy.olLayerGoogleV3.gmnoprint {
        visibility:hidden;
        display:none;
        width:100px;
        height:25px;
        left:0px;
        bottom: 0px;
    }
    html, body {
        margin  : 0;
        padding : 0;
        height  : 100%;
        width   : 100%;
    }
    a:link {color:#FF0000;}      /* unvisited link */
    a:visited {color:#00FF00;}  /* visited link */
    a:hover {color:#FF00FF;}  /* mouse over link */
    a:active {color:#0000FF;}  /* selected link */
    @media only screen and (max-width: 600px) {
        html, body {
            height  : 117%;
        }
    }
    #map {
        width    : 100%;
        position : relative;
        height   : 100%;
    }

</style>

<link rel="stylesheet" href="../js/OpenLayers-2.11/theme/default/style.css" type="text/css">
<script type="text/javascript">
var wtf


var map;
var WORDFILENAME = "NM-N6S-F5PS";
var DEFAULT_ZOOM = 11;
var __ISMOBILE = false;
function testMap(){
    __ISMOBILE = isMobile();
    function compareNumbers(a, b)
    {
        return a - b;
    }
    //wtf = new worldFile2( "img/output.png", "img/output.pgw", "EPSG:900913", donecall)

    wtf = new worldFile2( WORDFILENAME + ".png", WORDFILENAME + ".pgw", "EPSG:900913", donecall, __ISMOBILE)
    wtf.makeOLLayer("FIRE PROGRESSION");
    //load json file
    console.log("loading json");
    var jsr = $.getJSON(WORDFILENAME + ".json", function(data1) {
        console.log("loaded json")
        console.log(data1);
        MAX_TIME = data1.UTC[ data1.UTC.length - 1];
        MIN_TIME = data1.UTC[0];
        wtf._MAX_TIME = MAX_TIME;
        wtf._MIN_TIME = MIN_TIME;
        wtf.__TIME_UTC = MIN_TIME

        meta_data = data1;
        meta_data.acres.sort(compareNumbers);
        // data is a JavaScript object now. Handle it as such
        attachSlider();
        attachPlayButton()


        wtf.layer.draw();
        //map.zoomToExtent( wtf.layer.bounds)

    });
    jsr.error(function() { console.error("error loading json") })

}
function isMobile() {
    var uagent = navigator.userAgent.toLowerCase();
    var mobileSomething = (uagent.search('mobile') > -1)
    var ipoo = (uagent.search('iphone') > -1) || (uagent.search('ipad') > -1) || (uagent.search('ipod') > -1)
    return (mobileSomething || ipoo);
}
function init() {

    //stupid ie. why can't you work right
    //  stupid stupid internet explorer. why don't they define console.log like everybody else
    if(!window.console){ window.console = function(){}}
    if(!window.console.log){ window.console.log = function(){}}
    if(!window.console.warn){ window.console.warn = function(){}}
    if(!window.console.error){ window.console.error = function(){}}
    if(!console){ console = window.console }

    map = new OpenLayers.Map({
        div: "map"
    });

    var osm = new OpenLayers.Layer.OSM();


    console.log("init");

    //
    // try to add google layers. this fails when there is NOT network avaliable
    //    also google maps messes up the buttons on ios and some safari browsers for some reason. It sucks.
    if( false ){//!isMobile() ){
        try {
            var gphy = new OpenLayers.Layer.Google(
                    "Google Physical",
                    {type: google.maps.MapTypeId.TERRAIN}
            );
            var ghyb = new OpenLayers.Layer.Google(
                    "Google Hybrid",
                    {type: google.maps.MapTypeId.HYBRID, numZoomLevels: 20}
            );
            var gsat = new OpenLayers.Layer.Google(
                    "Google Satellite",
                    {type: google.maps.MapTypeId.SATELLITE, numZoomLevels: 22}
            );
            map.addLayers([ gphy, ghyb, gsat]);
        }
        catch(e) {
            console.error(e);
            logIt("google maps not found. Not using")
        }
    }
    //ESRI
    try{
        var esri = new OpenLayers.Layer.XYZ( "ESRI",
                "http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/${z}/${y}/${x}",
                {sphericalMercator: true} );
        map.addLayers([esri]);
    }
    catch(e){
        console.warn(e)
    }
// note that first layer must be visible
    map.addLayers([osm]);

    map.addControl(new OpenLayers.Control.LayerSwitcher());
    map.zoomToMaxExtent();
    //
    //Yahoo maps
    try{
        var yahoohyb = new OpenLayers.Layer.Yahoo("Yahoo Hybrid",
                {'type': YAHOO_MAP_HYB, 'sphericalMercator': true});
        map.addLayers([yahoohyb]);
    }
    catch(e){
        console.warn(e);
    }

//bing maps
    //
    try{
        var apiKey = "Aq_bIj3na4NLioAvQYQBAfZ-1sePxcscPVKjxUy2TaHXK96mXcgVxghp6gY4L3a1";

        var road = new OpenLayers.Layer.Bing({
            name: "Bing Road",
            key: apiKey,
            type: "Road"
        });
        var hybrid = new OpenLayers.Layer.Bing({
            name: "Bing Hybrid",
            key: apiKey,
            type: "AerialWithLabels"
        });
        var aerial = new OpenLayers.Layer.Bing({
            name: "Bing Aerial",
            key: apiKey,
            type: "Aerial"
        });

        map.addLayers([road, hybrid, aerial]);
    }
    catch(e){
        console.error("bing not loaded")
        console.error(e);
    }

    try{
        var nexrad_wms = new OpenLayers.Layer.WMS( "NEXRAD BASE REFLECT M45 MINS",
                "http://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r.cgi",
                {layers: 'nexrad-n0r-m45m',
                    exceptions:"application/vnd.ogc.se_xml",
                    transparent: "true", format: "image/png"},
                { tileSize: new OpenLayers.Size(256,256),
                    buffer: 1 } );
        nexrad_wms.visibility = false;
        map.addLayer( nexrad_wms)
    }
    catch(e){
        conole.error("nexrad not loaded", e);
    }
    //cloudmade
    //  they make cool maps
    var cloudmade = new OpenLayers.Layer.CloudMade("CloudMade midnight", {
        key: 'BC9A493B41014CAABB98F0471D759707',
        styleId:999//999 is midnight
    });
    map.addLayer(cloudmade);



    testMap()

}

var overl
var meta_data;
var MAX_TIME = 0;
var MIN_TIME = 0;
function donecall(){
    map.addLayer(wtf.layer);
    wtf.layer.draw()
    try{
        map.setCenter(transformprojection(wtf.stats.center));
    }
    catch(e){
        console.error(e)
    }
    map.zoomToExtent( wtf.layer.bounds)
    //map.zoomOut();
}

function transformprojection( ll ){
    var EPSG4326 = new OpenLayers.Projection("EPSG:4326"); // transform from WGS 1984
    var EPSG900913 = new OpenLayers.Projection("EPSG:900913");// to Spherical Mercator
    return ll.transform( EPSG4326, EPSG900913);
}
function sliderChanged(value){
    updateTime(value);
    $("#timeDiv").html("<div style='background-color: black; color: white'>"+new Date(value)+'</div>');
    wtf.layer.draw();
    updateAcreage( value)
}
function updateAcreage(tm){
    var acr = 0;
    if( tm <  meta_data.UTC[ 0 ]){
        acr =  meta_data.acres[ 0 ]
    }
    else if(tm >=  meta_data.UTC[  meta_data.UTC.length - 1 ]){
        acr =  meta_data.acres[  meta_data.acres.length - 1 ]
    }
    else{
        for( var i=1; i < meta_data.UTC.length; i++){
            if( meta_data.UTC[ i-1 ] <= tm && meta_data.UTC[i] >= tm){
                var da = meta_data.acres[i] - meta_data.acres[i-1];
                var dtt = meta_data.UTC[i] - meta_data.UTC[i-1];
                var dt = tm - meta_data.UTC[i-1];
                acr = meta_data.acres[i-1] + da * (dt/dtt);
                //acr = meta_data.acres[i]

            }

        }
    }
    acr = Math.round(acr)
    $("#acreage").html("<div style='background-color: black; color: white'>" + acr + ' acres</div>');
}
function attachSlider(){
    var min = meta_data.UTC[0];
    var max = meta_data.UTC[meta_data.UTC.length-1];
    var range = max-min;

    var slizzle = $( "#slider2" ).slider({min:min-10, max:max+10, value: wtf.__TIME_UTC, animate:true});
    $( "#slider2" ).bind( "slide", function(){
        var value = $('#slider2').slider('option', 'value');
        PLAYSTATES.state = PLAYSTATES.STOPPED;
        sliderChanged( value)
    });
    $( "#slider2" ).bind( "slidechange", function(){
        var value = $('#slider2').slider('option', 'value');
        sliderChanged( value)
    });

    //ticks
    var tickCan = document.getElementById("_tickCan");
    tickCan.width = $( "#slider2" ).width();
    tickCan.height = 10;
    var ctx2 = tickCan.getContext('2d');

    ctx2.fillColor = 'rgb(128,128,128)';
    ctx2.fillRect(0,0, tickCan.width, tickCan.height);
    ctx2.strokeStyle = 'rgb(100,128,255)';
    ctx2.beginPath();
    ctx2.lineWidth = 3;

    for( var i=0; i< meta_data.UTC.length; i++){
        var dist =  meta_data.UTC[i];
        var x=((dist - min)/ range)*tickCan.width;
        ctx2.lineWidth = 3;
        ctx2.moveTo(x,0);
        ctx2.lineTo(x,100);
    }
    ctx2.closePath();
    ctx2.stroke();

}

function attachPlayButton()
{
    $( "#beginning" ).button({
        text: false,
        icons: {
            primary: "ui-icon-seek-start"
        }
    }).click(function(){
                changeTime(wtf._MIN_TIME)
            });
    $( "#rewind" ).button({
        text: false,
        icons: {
            primary: "ui-icon-seek-prev"
        }
    }).click(function(){
                console.log("forward clicked")
                if( wtf.__TIME_UTC <= wtf._MIN_TIME){
                    changeTime(  wtf._MAX_TIME);
                }
                else{
                    for( var i=0; i < meta_data.UTC.length-1; i++){
                        if(  meta_data.UTC[i] < wtf.__TIME_UTC && meta_data.UTC[i+1] >= wtf.__TIME_UTC){
                            changeTime( meta_data.UTC[i]);
                            break
                        }
                    }
                }
            });
    $( "#play" ).button({
        text: false,
        icons: {
            primary: "ui-icon-play"
        }
    })
            .click(function() {
                startAnim();
            });
    $( "#stop" ).button({
        text: false,
        icons: {
            primary: "ui-icon-stop"
        }
    })
            .click(function() {
                stopAnim()
            });
    $( "#forward" ).button({
        text: false,
        icons: {
            primary: "ui-icon-seek-next"
        }
    }).click(function(){
                console.log("forward clicked")
                if( wtf.__TIME_UTC >= wtf._MAX_TIME){
                    changeTime(  wtf._MIN_TIME);
                }
                else{
                    for( var i=0; i < meta_data.UTC.length-1; i++){
                        if(  meta_data.UTC[i] <= wtf.__TIME_UTC && meta_data.UTC[i+1] > wtf.__TIME_UTC){
                            changeTime( meta_data.UTC[i+1]);
                            break
                        }
                    }
                }
            });
    $( "#end" ).button({
        text: false,
        icons: {
            primary: "ui-icon-seek-end"
        }
    }).click(function(){
                console.log("end clicked");
                changeTime(wtf._MAX_TIME+1)

            });
    $('#refresh').button({
        text:false,
        icons:{ primary:"ui-icon-arrowrefresh-1-w"}
    }).click(function(){
                map.zoomToExtent( wtf.layer.bounds)

            })
}


function changeTime(tim){
    $('#slider2').slider("value",tim);
}


requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
        window.webkitRequestAnimationFrame || window.msRequestAnimationFrame || function(func){setTimeout(func,100)};
var _playInterval=3000000
var _animat
var PLAYSTATES = {PLAYING:"playing",STOPPED:"stopped",state:"stopped"};
function animate(){

    //console.log("animate")
    if( wtf.__TIME_UTC >= wtf._MAX_TIME){
        console.log("end of tape reached")
        stopAnim();
    }
    else if( PLAYSTATES.state == PLAYSTATES.PLAYING) {
        if(__ISMOBILE){
            changeTime( wtf.__TIME_UTC + 10*_playInterval);
        }
        else{
            changeTime( wtf.__TIME_UTC + _playInterval);
        }
        requestAnimationFrame(animate)
    }

}
function startAnim(){
    if( wtf.__TIME_UTC >= wtf._MAX_TIME){
        wtf.__TIME_UTC = wtf._MIN_TIME;
    }
    if( PLAYSTATES.state == PLAYSTATES.PLAYING){
        stopAnim()
    }
    else{
        PLAYSTATES.state = PLAYSTATES.PLAYING;
        var buttOptions = {label: "pause",	icons: {primary: "ui-icon-pause"}  };
        $('#play').button( "option", buttOptions );
        animate();
    }
}
function stopAnim(){
    PLAYSTATES.state = PLAYSTATES.STOPPED;
    var buttOptions = {label: "pause",	icons: {primary: "ui-icon-play"}  };
    $('#play').button( "option", buttOptions );
}

function updateTime(tm){
    wtf.__TIME_UTC = tm;
    $("#timeDiv").html("<div style='background-color: black; color: white'>"+new Date(tm)+'</div>');
}
</script>
<title>NM-N6S-F5PS .   LAS CONCHAS. Fire Progression. 2012</title>

<script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-32838344-1']);
    _gaq.push(['_trackPageview']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

</script>

</head>
<body onload="init()" style="background: black; color: white">
<div style="height: 100%; width: 100%">
    <a href="index.html" style="float:left"> Index</a> <h3 style="text-align: center; padding: 0px; margin: 0px">NM-N6S-F5PS.   LAS CONCHAS. 2012</h3>

    <div class="demo" style=" padding-left: 10px !important; width:90%  ">

        <div id="slider2" style="width:100%" ></div>
        <div id="ticks"></div>
        <canvas id="_tickCan" style="width:100%"></canvas>
        <div>
            <div id="timeDiv" style="float: left">0</div>
            <div id="acreage" style="float: right" >0</div>
        </div>

        <span id="toolbar" class="ui-widget-header ui-corner-all" style="position:absolute; z-index:2000; left: 55px; top:70px">
        	<button id="beginning">go to beginning</button>
        	<!-- <button id="rewind">rewind</button>-->
        	<button id="play">play/stop</button>
        	<!--<button id="stop">stop</button>-->
          <!--  <button id="refresh">reset view</button> -->
        	<!-- <button id="forward">fast forward</button> -->
        	<button id="end">go to end</button>

        </span>
        <a href="http://www.simtable.com"><img src="../img/logo.png" style="position:absolute; z-index:2000; right: 10px; bottom:10px" ></a>


    </div><!-- End demo -->
    <br>
    <div id="map" class="smallmap" style="width:100%; height: 100%"></div>
    <div>
        made by  <a href="http://www.redfish.com/">RedfishGroup</a>, credit Cody Smith. Source Progression files from  <a href="http://rmgsc.cr.usgs.gov/">USGS</a>
    </div>

</div>


</body>
</html>